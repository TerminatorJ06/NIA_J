<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B.Arch. Curriculum & Technology Planner (5-Year) - Nitte University (Google Drive Sync)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> <!-- Optional: for icons -->

    <!-- Google Identity Services and Google API Client Library -->
    <!-- The onload functions are defined below in the script tag -->
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
    <script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

    <style>
        /* --- Start of Refined CSS v6 (with Google Drive Additions) --- */
        :root {
            --primary-color: #0077b6; /* Slightly softer blue */
            --primary-dark: #023e8a;
            --secondary-color: #48cae4; /* Complementary lighter blue */
            --secondary-dark: #0096c7;
            --text-color: #333;
            --heading-color: #1a202c; /* Even darker blue-grey */
            --background-color: #f4f7f6; /* Light grey background */
            --container-bg: #fff;
            --border-color: #e9ecef; /* Lighter border grey */
            --light-grey: #f8f9fa; /* Very light grey */
            --medium-grey: #ced4da; /* Medium grey for borders/dividers */
            --dark-grey: #6c757d; /* Slightly darker grey for helper text */
            --editable-bg: #fffbe6; /* Soft yellow for editable */
            --highlight-color: #e0f7fa; /* Very light blue highlight on focus */
            --delete-color: #e74c3c; /* Red */
            --delete-dark: #c0392b;

            /* New color for unused themes */
            --unused-bg: #f8d7da; /* Very light red background */
            --unused-text: #721c24; /* Darker red text */
            --unused-border: #f5c6cb; /* Medium red border */

             /* New color for summary tables */
             --summary-bg: #eef2f7; /* Match header background */
             --summary-header-bg: var(--primary-color);
             --summary-header-text: white;

             /* Google Drive Button Style */
             --google-blue: #4285F4;
             --google-blue-dark: #357ae8;

             /* Status Text Color for Unsaved */
             --unsaved-color: #ffc107; /* Warning yellow */
        }

        body {
            font-family: 'Poppins', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 25px 20px; /* More vertical padding */
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 15px; /* Slightly smaller base size */
        }

        .curriculum-planner {
            max-width: 1800px; /* Max width of the main container */
            margin: 20px auto;
            background-color: var(--container-bg);
            padding: 40px 50px; /* Increased padding */
            border-radius: 12px; /* Slightly more rounded corners */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Softer, wider shadow */
            /* Allow container to shrink below max-width if needed for smaller screens */
             width: auto;
        }

        h1, h2 {
             text-align: center;
             color: var(--heading-color);
             font-weight: 600;
        }
        h1 { font-size: 2.4em; margin-bottom: 10px; margin-top: 0;}
        h2 { font-size: 1.4em; margin-bottom: 45px; font-weight: 400; color: var(--dark-grey); }

        h3 { /* Semester Titles */
            color: var(--primary-dark);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 12px; /* More padding below title */
            margin-top: 60px; /* More space above sections */
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.7em;
        }
         h4 { /* General Notes Title & Summary Title */
            color: var(--heading-color);
            margin-top: 50px;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: 500; /* Slightly less bold */
         }

        .semester-summary {
            font-size: 0.95em;
            font-style: italic;
            color: var(--dark-grey);
            margin-top: 10px;
            margin-bottom: 35px; /* More space below summary */
            padding: 18px 25px; /* Increased padding */
            background-color: var(--light-grey);
            border-left: 5px solid var(--primary-color); /* Wider border */
            border-radius: 5px; /* Slightly more rounded */
            min-height: 45px; /* Ensure clickable area */
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
             line-height: 1.5; /* Slightly more open line height */
             white-space: pre-wrap; /* Ensure line breaks are respected */
             text-align: left; /* Changed from center */
        }
        .semester-summary[contenteditable="true"] {
            background-color: var(--editable-bg);
            cursor: text;
             font-style: normal; /* Remove italic when editing */
        }
        .semester-summary[contenteditable="true"]:focus {
             outline: none;
             box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.2); /* Softer, blue outline */
             background-color: var(--container-bg);

        }

        p.instructions {
            display: block;
            text-align: center;
            margin-bottom: 45px; /* More space below instructions */
            color: var(--dark-grey);
            font-size: 0.9em;
            font-style: italic;
            line-height: 1.5;
        }

        /* Table Container for Responsiveness */
        .table-responsive {
            width: 100%; /* Take full width of parent */
            overflow-x: auto; /* Enable horizontal scrolling */
            margin-bottom: 25px; /* More space below table */
            border: 1px solid var(--border-color); /* Add light border to container */
            border-radius: 8px; /* Rounded corners for container */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Subtle shadow */
             /* min-width defined within specific table-responsive styles */
        }

         /* Specific min-width for curriculum tables */
        .semester-section .table-responsive {
             min-width: 1700px; /* Increased min-width to make table wider */
        }

         /* Scrollbar styling */
        .table-responsive::-webkit-scrollbar {
            height: 8px;
        }
        .table-responsive::-webkit-scrollbar-thumb {
            background: var(--medium-grey);
            border-radius: 10px;
        }
        .table-responsive::-webkit-scrollbar-track {
            background: var(--light-grey);
        }
         .table-responsive table {
             border: none; /* Remove inner table border as container has one */
             width: 100%; /* Table fills the min-width of its container */
             table-layout: fixed; /* Keep fixed layout for controlled columns */
         }

        /* Planner Table Styles */
        table {
            border-collapse: collapse;
            font-size: 0.9em; /* Slightly smaller table font */
        }

        th, td {
            border: 1px solid var(--border-color); /* Lighter inner borders */
            padding: 14px 12px; /* More padding */
            text-align: left;
            vertical-align: top; /* Keep top alignment for text cells */
            word-wrap: break-word;
            overflow-wrap: break-word;
             line-height: 1.5; /* Open line height in cells */
        }

        th {
            background-color: #eef2f7; /* Very light blueish-grey header */
            color: var(--heading-color);
            font-weight: 600;
            vertical-align: middle; /* Keep middle for header text/small */
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 2px solid var(--medium-grey); /* Stronger bottom border */
        }
         th small {
             display: block;
             font-weight: 400;
             font-size: 0.8em; /* Smaller hint text */
             color: var(--dark-grey);
             margin-top: 5px;
         }

        /* Apply specific widths to columns (12 columns including Delete) */
        /* Adjusted widths to provide more space for notes/remarks */
        .semester-section th:nth-child(1), .semester-section td:nth-child(1) { width: 4%; }  /* Code */
        .semester-section th:nth-child(2), .semester-section td:nth-child(2) { width: 11%; } /* Title */
        .semester-section th:nth-child(3), .semester-section td:nth-child(3) { width: 4%; text-align: center; } /* Credits */
        .semester-section th:nth-child(4), .semester-section td:nth-child(4) { width: 6%; }  /* Default RIBA (D) */
        .semester-section th:nth-child(5), .semester-section td:nth-child(5) { width: 6%; }  /* Acad/Prac RIBA (D) */
        .semester-section th:nth-child(6), .semester-section td:nth-child(6) { width: 12%; } /* Acad/Prac Notes */
        .semester-section th:nth-child(7), .semester-section td:nth-child(7) { width: 6%; }  /* Ethics RIBA (D) */
        .semester-section th:nth-child(8), .semester-section td:nth-child(8) { width: 12%; } /* Ethics Notes */
        .semester-section th:nth-child(9), .semester-section td:nth-child(9) { width: 6%; }  /* Tech RIBA (D) */
        .semester-section th:nth-child(10), .semester-section td:nth-child(10){ width: 12%; }/* Tech Notes */
        .semester-section th:nth-child(11), .semester-section td:nth-child(11){ width: 6%; }  /* Remarks */
        .semester-section th:nth-child(12), .semester-section td:nth-child(12){ width: 2%; text-align: center;} /* Actions */


        tbody tr:nth-child(even) {
            background-color: var(--f8f9fa); /* Very subtle zebra striping */
        }

        tbody tr:hover:not(.total-credits-row) {
            background-color: var(--highlight-color); /* Light blue hover */
        }

        td[contenteditable="true"] {
            background-color: var(--container-bg);
            cursor: text;
            min-height: 35px; /* Ensure space for editing */
            outline: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
             white-space: pre-wrap; /* Ensure line breaks are respected */
        }

        td[contenteditable="true"]:hover {
             background-color: var(--editable-bg); /* Hint on hover */
        }

        td[contenteditable="true"]:focus {
            background-color: var(--highlight-color);
            box-shadow: inset 0 0 0 1px var(--primary-color); /* Inner border on focus */
        }

        /* Styling for RIBA dropdown cell */
        td.riba-cell {
             background-color: var(--container-bg);
             padding: 8px 6px; /* Adjusted padding for select */
             vertical-align: top; /* Changed from middle */
             min-height: 35px; /* Match other editable cells */
        }

        select.riba-select {
            width: 100%;
            padding: 8px 6px; /* Adjusted padding */
            border: 1px solid var(--medium-grey);
            border-radius: 4px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9em;
            background-color: var(--container-bg);
            box-sizing: border-box;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23555%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px center; /* More space for arrow */
            background-size: 12px auto; /* Slightly larger arrow */
            cursor: pointer;
             vertical-align: top; /* Ensure select box itself aligns top */
        }
        select.riba-select:focus {
             outline: none;
             border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.2);
        }
         select.riba-select option {
             padding: 4px;
         }


        /* Styling for the total credits row */
        .total-credits-row td {
            background-color: #e9ecef;
            font-weight: 600; /* Slightly less bold */
            color: var(--heading-color);
            border-top: 2px solid var(--medium-grey);
            vertical-align: middle;
            padding: 14px 12px; /* Match row padding */
        }
        .total-credits-row td:first-child { text-align: right; padding-right: 20px;} /* More space */
        .total-credits-row td:nth-child(2) { /* Total Credits Number */
            font-size: 1.1em;
            text-align: center;
            font-weight: 700; /* Make number bolder */
            color: var(--primary-dark); /* Highlight total */
        }
         /* The third TD in total row now spans the remaining columns visually */
        .total-credits-row td:nth-child(3) {
             background-color: transparent;
        }


        /* General Notes Area */
        #general-notes-section {
             margin-top: 60px; /* More space above */
        }
        #general-notes-area {
            width: 100%;
            min-height: 200px; /* Taller textarea */
            padding: 15px;
            border: 1px solid var(--medium-grey);
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 1em;
            box-sizing: border-box;
            resize: vertical;
             outline: none;
             transition: border-color 0.3s ease, box-shadow 0.3s ease;
             line-height: 1.6;
             white-space: pre-wrap; /* Ensure line breaks */
        }
         #general-notes-area:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.2);
         }

        /* Buttons */
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 13px 28px; /* Slightly larger padding */
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            border-radius: 6px; /* Slightly more rounded */
            cursor: pointer;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
            margin-top: 20px; /* More space above buttons */
            margin-right: 10px;
            font-weight: 500; /* Medium weight */
        }

        button:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        button:active {
             background-color: #00548c;
             box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }


        /* Google Drive Specific Button Styles */
        #google-drive-buttons button {
             background-color: var(--google-blue);
        }
         #google-drive-buttons button:hover {
             background-color: var(--google-blue-dark);
         }
          #google-drive-buttons button:active {
             background-color: #1a5cdb; /* Slightly darker */
          }

        /* Hide buttons conditionally */
         #sign-in-button[hidden] { display: none; }
         #sign-out-button[hidden] { display: none; }
         #save-to-drive-button[hidden] { display: none; }
         #load-from-drive-button[hidden] { display: none; }


        .add-course-button-container {
             margin-top: 15px; /* Space above add button */
             text-align: left; /* Align add button left */
        }
         .action-buttons {
             text-align: center;
             margin-top: 50px; /* More space above global action buttons */
         }
        .google-drive-status {
             text-align: center;
             margin-top: 10px;
             font-size: 0.9em;
             color: var(--dark-grey);
             min-height: 1.2em; /* Reserve space */
             /* Use JS to set color based on state */
        }
         .google-drive-status.unsaved {
             color: var(--unsaved-color);
         }
         .google-drive-status.error {
             color: var(--delete-dark);
         }
         .google-drive-status.success {
             color: var(--primary-dark);
         }


        /* Delete button specific styles */
        td.delete-cell {
             text-align: center;
             vertical-align: middle;
             padding: 10px 6px; /* Adjusted padding to be less */
        }
        .delete-row-button {
             background: none;
             border: none;
             color: var(--delete-color); /* Red color for delete */
             font-size: 1.3em; /* Slightly larger icon */
             cursor: pointer;
             padding: 4px; /* Reduced padding */
             margin: 0;
             transition: color 0.2s ease;
             line-height: 1;
             display: inline-flex;
             align-items: center;
             justify-content: center;
        }
        .delete-row-button:hover {
             color: var(--delete-dark);
             background: none;
             box-shadow: none;
        }
         .delete-row-button:active {
             color: #a93226; /* Even darker red */
             background: none;
             box-shadow: none;
         }

        /* New styles for Unused RIBA Themes section */
        .unused-riba-section {
            margin-top: 25px;
            margin-bottom: 30px;
            padding: 15px 20px;
            background-color: var(--unused-bg);
            border: 1px solid var(--unused-border);
            border-radius: 5px;
            font-size: 0.9em;
            color: var(--unused-text);
            line-height: 1.5;
        }
         .unused-riba-section p {
             margin: 0; /* Remove default paragraph margin */
             white-space: pre-wrap; /* Preserve line breaks if needed */
         }
         .unused-riba-section strong {
             color: var(--unused-text); /* Ensure title is also dark red */
         }

        /* New styles for RIBA Summary Table section */
        .riba-summary-section {
             margin-top: 60px; /* Space above this section */
             margin-bottom: 40px; /* Space below */
        }

        .riba-summary-section .table-responsive {
             /* Adjust min-width if needed, but 12 columns might fit better than 1700px */
             min-width: 1000px; /* Example smaller min-width for summary */
        }


        #riba-summary-table th {
             background-color: var(--summary-header-bg); /* Darker blue for summary header */
             color: var(--summary-header-text); /* White text */
             font-weight: 600;
             border-color: var(--primary-dark); /* Stronger border */
             text-align: center; /* Center header text */
             vertical-align: middle;
             padding: 10px 8px; /* Slightly less padding than main table headers */
        }
         #riba-summary-table th:first-child {
             text-align: left; /* Align theme name left */
             background-color: #eef2f7; /* Match main table header background */
             color: var(--heading-color); /* Match main table header text */
             border-color: var(--medium-grey);
             position: sticky; /* Sticky theme column */
             left: 0;
             z-index: 2; /* Higher z-index than sticky header */
         }

         #riba-summary-table td {
             text-align: center; /* Center count numbers */
             vertical-align: middle;
             padding: 8px 6px; /* Less padding for numbers */
             background-color: var(--summary-bg); /* Light background for body */
         }

         #riba-summary-table tbody tr:nth-child(even) td {
              background-color: var(--light-grey); /* Subtle zebra for rows */
         }

         #riba-summary-table td:first-child {
              text-align: left; /* Align theme name left */
              font-weight: 500; /* Medium weight for theme name */
              background-color: var(--container-bg); /* White background for theme cell */
              position: sticky; /* Sticky theme cell */
              left: 0;
              z-index: 1; /* Lower z-index than sticky header */
         }
         #riba-summary-table tr:hover td {
             background-color: var(--highlight-color); /* Highlight on hover */
         }
          #riba-summary-table tr:hover td:first-child {
             background-color: var(--highlight-color); /* Ensure sticky cell also highlights */
          }


        /* Optional: Toast/Notification for save */
        .save-notification {
            position: fixed;
            bottom: 25px; /* Higher from bottom */
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745; /* Success green */
            color: white;
            padding: 14px 25px; /* More padding */
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
             box-shadow: 0 4px 12px rgba(0,0,0,0.15);
             font-size: 1em;
             font-weight: 500;
             max-width: 80%; /* Prevent overflow on small screens */
             text-align: center;
        }
        .save-notification.show {
            opacity: 1;
            visibility: visible;
        }
         .save-notification.error {
             background-color: #dc3545; /* Error red */
         }
          .save-notification.info {
             background-color: #ffc107; /* Warning yellow */
              color: #343a40;
         }
         .save-notification.info.show {
            opacity: 1; visibility: visible;
            background-color: #ffc107; /* Warning yellow */
            color: #343a40;
         }


        /* Ensure textarea in notes/remarks preserves spaces */
        /* This is handled by white-space: pre-wrap and innerHTML/value */

        /* --- End of Refined CSS v6 --- */
    </style>
</head>
<body>

<div class="curriculum-planner">
    <h1>B.Arch. Curriculum Planner 2025</h1>
    <h2>Nitte Institute of Architecture - Based on Batch 2020-21 Regulations</h2>
    <p class="instructions"><em>Click on table cells or summary paragraphs to edit. Use dropdowns for Default and Direct RIBA theme connections. Credit totals update automatically. Unused RIBA themes per semester are listed below each table. Use the Google Drive buttons below to save and load your planner data from your Google Drive. Delete rows using the <span style="color: var(--delete-color); font-weight: 600;">&times;</span> button in the Actions column.</em></p>

    <!-- Google Drive Actions -->
    <div class="action-buttons" id="google-drive-buttons">
        <button id="sign-in-button">Sign In with Google</button>
        <button id="sign-out-button" hidden>Sign Out</button>
        <button id="save-to-drive-button" hidden disabled>Save to Google Drive</button>
        <button id="load-from-drive-button" hidden disabled>Load from Google Drive</button>
    </div>
     <div class="google-drive-status" id="google-drive-status">Loading Google API...</div>


    <!-- --- Semester Tables (Sem 1 to 10) --- -->

    <!-- Semester 1 -->
    <div class="semester-section">
        <h3>Semester 1 (Level 1: Foundation)</h3>
        <p class="semester-summary" id="sem1-summary" contenteditable="true">
            **Overall Theme:** Fundamentals of Design and Representation<br>
            **Focus:** This semester lays the essential groundwork for the entire program. The focus is on developing fundamental visual literacy, manual and basic digital representation skills, introducing foundational design concepts, and understanding the basic physics influencing the built environment. It's about learning the initial language and tools of architecture. Successful completion is crucial as it provides the basic toolkit required for all subsequent design and technical studies.
        </p>
        <div class="table-responsive">
        <table id="sem1-table">
            <thead>
                <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR11</td>
                    <td contenteditable="true" spellcheck="false">Foundation Studio</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">12</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Intro Digital Fabrication (3D Print, Laser Cut workshop). Digital Models.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td> <!-- Delete Button -->
                </tr>
                 <tr>
                    <td contenteditable="true" spellcheck="false">20BAR12</td>
                    <td contenteditable="true" spellcheck="false">Culturescapes</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR13</td>
                    <td contenteditable="true" spellcheck="false">Environment and Building Physics</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">6</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Basic Climate Analysis Tools (Climate Consultant or similar). Climate Data Viz.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR14</td>
                    <td contenteditable="true" spellcheck="false">Architectural and Visual Representation</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Intro 2D CAD (AutoCAD). Digital Graphics & Presentation (Adobe PS, AI, ID).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <!-- Total Credits Row -->
                <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 1 Total</strong></td>
                    <td><strong>0</strong></td> <!-- Credits Total -->
                    <td colspan="9"></td> <!-- Spans remaining columns -->
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem1-table')">Add Course to Semester 1</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem1-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

    <!-- Semester 2 -->
     <div class="semester-section">
        <h3>Semester 2 (Level 1: Foundation)</h3>
        <p class="semester-summary" id="sem2-summary" contenteditable="true">
            **Overall Theme:** Introduction to Architectural Design and Spatial Thinking<br>
            **Focus:** Building on the foundations of Sem 1, this semester introduces students to the core activity of architectural design within a simplified context. Emphasis is placed on developing spatial awareness, applying basic structural/environmental principles, and using both physical models and introductory 3D digital tools (like SketchUp) to explore form and space. The Communication course refines the representation skills acquired in Sem 1. This semester solidifies the transition from abstract principles to concrete design exploration and sets the stage for tackling more complex design problems in Level 2.
        </p>
        <div class="table-responsive">
        <table id="sem2-table">
            <thead>
                <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR21</td>
                    <td contenteditable="true" spellcheck="false">Introduction to Architectural Design</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">12</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Intro 3D Modeling (SketchUp). Digital Models + Physical Prototypes.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR22</td>
                    <td contenteditable="true" spellcheck="false">Architecture and Change</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR23</td>
                    <td contenteditable="true" spellcheck="false">Climate, Site and Superstructure</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">6</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Climate Data Viz.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR24</td>
                    <td contenteditable="true" spellcheck="false">Graphics and Communication</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Digital Drawing & Graphics (CAD, Adobe Suite).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 2 Total</strong></td>
                    <td><strong>0</strong></td>
                     <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem2-table')">Add Course to Semester 2</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem2-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

    <!-- Semester 3 -->
    <div class="semester-section">
        <h3>Semester 3 (Level 2: Development)</h3>
        <p class="semester-summary" id="sem3-summary" contenteditable="true">
            **Overall Theme:** Integrated Design and Workflow Development<br>
            **Focus:** This semester marks the beginning of Level 2, focusing on developing more integrated design approaches. A key milestone is the mandatory introduction of BIM (Revit) within the studio, shifting from basic representation to integrated building information modeling. Technical courses delve deeper into environmental and structural principles with introductory simulation concepts. Electives offer initial exposure to computational design and coding, expanding the digital toolkit. This semester emphasizes connecting different aspects of architectural knowledge and introducing essential digital workflows for the rest of the program.
        </p>
        <div class="table-responsive">
        <table id="sem3-table">
             <thead>
                 <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR31</td>
                    <td contenteditable="true" spellcheck="false">S3 Vertical Studio</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">12</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Mandatory BIM Introduction (Revit). Intermediate Rendering & Collaboration (Enscape/V-Ray, Miro). Milestone.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR32</td>
                    <td contenteditable="true" spellcheck="false">History and Construction</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR33</td>
                    <td contenteditable="true" spellcheck="false">Environment and Building Structures</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">6</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Basic Env. Simulation (Ladybug Tools). Intro Structural Analysis concepts/SW (e.g., STAAD Pro, ETABS).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L2)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(One L2 Elective Recommended). Options: Intro Computational Design (Rhino + GH - Milestone), Python Basics (VAC?).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 3 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem3-table')">Add Course to Semester 3</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem3-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

    <!-- Semester 4 -->
    <div class="semester-section">
        <h3>Semester 4 (Level 2: Development)</h3>
         <p class="semester-summary" id="sem4-summary" contenteditable="true">
            **Overall Theme:** Design of Habitable Environments<br>
            **Focus:** Applying the integrated workflow introduced in Sem 3, this semester focuses on the complex programmatic and spatial requirements of housing design. Students consolidate their BIM proficiency by developing detailed housing projects. Technical studies continue to build knowledge of building systems, incorporating basic simulation for specific aspects like lighting. This semester deepens the understanding of designing for human needs and provides a solid foundation for more specialized building types in later studios.
        </p>
        <div class="table-responsive">
        <table id="sem4-table">
             <thead>
                <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR41</td>
                    <td contenteditable="true" spellcheck="false">Housing Studio</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">12</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">BIM application (Revit - Milestone). Rendering & Collaboration (Enscape/V-Ray, Miro).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR42</td>
                    <td contenteditable="true" spellcheck="false">History and Urbanism 1</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR43</td>
                    <td contenteditable="true" spellcheck="false">Building Systems & Electrical Services</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">6</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Basic Lighting Simulation.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L2)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(One L2 Elective Recommended). Options: Continue Comp Design, Python, etc.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 4 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem4-table')">Add Course to Semester 4</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem4-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

     <!-- Semester 5 -->
    <div class="semester-section">
        <h3>Semester 5 (Level 2: Development)</h3>
         <p class="semester-summary" id="sem5-summary" contenteditable="true">
            **Overall Theme:** Technical Resolution and Advanced Digital Exploration<br>
            **Focus:** This semester pushes students toward greater technical understanding and introduces more advanced digital methodologies. Detailing focuses on the practicalities of construction, while the studio and electives integrate sophisticated tools like computational design (Grasshopper) for complex forms/analysis, real-time rendering, and emerging technologies like AI and robotics. This semester deepens technical knowledge, broadens the digital skill set, and prepares students for the professional internship by exposing them to tools increasingly relevant in practice.
        </p>
        <div class="table-responsive">
        <table id="sem5-table">
             <thead>
                 <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                 <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR51</td>
                    <td contenteditable="true" spellcheck="false">S5 Vertical Studio</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">12</td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Advanced BIM Application (Revit). Computational Design Application (Grasshopper for Form-finding, Analysis). Real-time Rendering (Lumion, D5 Render).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr>
                    <td contenteditable="true" spellcheck="false">20BAR52</td>
                    <td contenteditable="true" spellcheck="false">History and Urbanism 2</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr>
                    <td contenteditable="true" spellcheck="false">20BAR53</td>
                    <td contenteditable="true" spellcheck="false">Building Detailing & Valuation</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">6</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Advanced BIM Application (Revit Details).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L2)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(One L2 Elective Recommended). Options: Intro AI in Arch (Milestone, e.g., concepts, Rayan.design), Intro Digital Fab/Robotics (Workflows, CNC - Milestone).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 5 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                 </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem5-table')">Add Course to Semester 5</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem5-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

     <!-- Semester 6 -->
    <div class="semester-section">
        <h3>Semester 6 (Level 2: Development)</h3>
         <p class="semester-summary" id="sem6-summary" contenteditable="true">
            **Overall Theme:** Applied Professional Practice<br>
            **Focus:** This is a dedicated semester for practical, real-world experience through a full-time internship. The focus shifts from academic learning to applying accumulated knowledge, skills, and digital proficiency (BIM, CAD, etc.) in a professional architectural office or related setting. It's a crucial period for understanding industry workflows, project management, ethical considerations, and communication within a team. This exposure bridges theory and practice, informing future academic choices and the final thesis project.
        </p>
        <div class="table-responsive">
        <table id="sem6-table">
             <thead>
                 <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR65</td>
                    <td contenteditable="true" spellcheck="false">Co-operative Learning</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">24</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Industry Software Exposure (Revit, CAD, etc.). Full semester internship/practical training.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 6 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem6-table')">Add Course to Semester 6</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem6-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

     <!-- Semester 7 -->
    <div class="semester-section">
        <h3>Semester 7 (Level 3: Specialization & Application)</h3>
        <p class="semester-summary" id="sem7-summary" contenteditable="true">
            **Overall Theme:** Urban Scale and Specialized Exploration<br>
            **Focus:** Transitioning to Level 3, the focus expands to the urban scale, requiring new tools like GIS and advanced data analysis for site understanding. Technical studies introduce complex simulations (CFD, ENVI-met) for deeper environmental understanding. Crucially, Level 3 Electives allow students to begin specializing in areas like advanced computation, AI, robotics, or visualization. This semester is about handling complexity at a larger scale and charting individual pathways toward specialization, setting the stage for thesis research and advanced studios.
        </p>
        <div class="table-responsive">
        <table id="sem7-table">
             <thead>
                 <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR71</td>
                    <td contenteditable="true" spellcheck="false">Urban Studio / Exchange Studio</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">12</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">GIS (ArcGIS/QGIS). Data Viz. Photogrammetry SW.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR73</td>
                    <td contenteditable="true" spellcheck="false">Building Systems and Practices</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">6</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Advanced Simulation (DesignBuilder, Autodesk CFD, ENVI-met).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L3/Open/Global)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(Two Electives Recommended). Options: Adv. Comp Design, AI Apps (e.g., Rayan.design applications), Robotics in Fab, AR/VR, Adv. Viz.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L3/Open/Global)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(See above).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 7 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem7-table')">Add Course to Semester 7</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem7-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

    <!-- Semester 8 -->
    <div class="semester-section">
        <h3>Semester 8 (Level 3: Specialization & Application)</h3>
        <p class="semester-summary" id="sem8-summary" contenteditable="true">
            **Overall Theme:** Research and Thematic Design Application<br>
            **Focus:** This semester allows students to apply their developing specialization and research skills within thematic vertical studios and the independent Dissertation. Studios offer options like Conservation, Sustainability, etc., where students can integrate specific advanced tools (Scan-to-BIM, advanced simulation, structural analysis software) relevant to the theme. The Dissertation focuses on developing research methodologies and critical thinking, often supported by digital analysis tools. This semester links specialized academic inquiry with targeted design exploration.
        </p>
        <div class="table-responsive">
        <table id="sem8-table">
            <thead>
                 <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR81 X*</td>
                    <td contenteditable="true" spellcheck="false">Vertical Studio 2</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">12</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(Options: Adv. Design, Cons., Landscape, Sustain., Urban Housing). Tech applied contextually, e.g., Scan-to-BIM in Conservation, Simulation in Sustainability, Structural analysis (STAAD/ETABS), BIM Coordination (Navisworks?).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR83</td>
                    <td contenteditable="true" spellcheck="false">Management and Interior Systems</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">6</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR85</td>
                    <td contenteditable="true" spellcheck="false">Dissertation</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Research Tools, Data Analysis (Python/AI tools?).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L3/Open/Global)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(One Elective Recommended). Specialize based on Sem 7 choices.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 8 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem8-table')">Add Course to Semester 8</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem8-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

     <!-- Semester 9 -->
     <div class="semester-section">
        <h3>Semester 9 (Level 3: Specialization & Application)</h3>
        <p class="semester-summary" id="sem9-summary" contenteditable="true">
            **Overall Theme:** Professional Consolidation and Practical Application<br>
            **Focus:** A second full-semester internship offers deeper engagement with professional practice. This period is crucial for consolidating all academic learning, including design, technical, and digital skills, in a real-world context. Students apply integrated BIM workflows, project management concepts, and ethical reasoning learned in previous semesters. The focus is on gaining confidence, understanding the business realities of practice, and preparing for entry into the profession immediately after graduation.
        </p>
        <div class="table-responsive">
        <table id="sem9-table">
             <thead>
                 <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR95</td>
                    <td contenteditable="true" spellcheck="false">Co-operative Learning</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">24</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Industry Software Exposure (Revit, CAD, etc.). Full semester internship/practical training.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 9 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem9-table')">Add Course to Semester 9</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem9-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

     <!-- Semester 10 -->
    <div class="semester-section">
        <h3>Semester 10 (Level 3: Specialization & Application)</h3>
        <p class="semester-summary" id="sem10-summary" contenteditable="true">
            **Overall Theme:** Mastery and Professional Readiness (Thesis/Capstone)<br>
            **Focus:** The final semester culminates in the Architectural Thesis or Capstone Project, a self-directed undertaking synthesizing all academic knowledge and practical internship experience. Students demonstrate mastery by applying advanced design methodologies, integrating complex technical systems (building on Sem 7), leveraging specialized digital tools based on project needs (computational design, simulation, fabrication, BIM coordination), and presenting their work professionally using advanced visualization techniques (VR/AR). The Professional Practice course directly addresses the business and ethical aspects of entering the profession, ensuring graduates are well-rounded and ready for licensure and practice.
        </p>
        <div class="table-responsive">
        <table id="sem10-table">
             <thead>
                 <tr> <!-- 12 Columns -->
                    <th>Code</th>
                    <th>Title</th>
                    <th>Credits</th>
                    <th>Default RIBA<br><small>(Main Theme)</small></th>
                    <th>Acad/Prac RIBA<br><small>(Direct)</small></th>
                    <th>Academic & Practice Notes</th>
                    <th>Ethics RIBA<br><small>(Direct)</small></th>
                    <th>Ethics & Comm. Notes</th>
                    <th>Tech RIBA<br><small>(Direct)</small></th>
                    <th>Tech Integration Notes</th>
                    <th>Remarks</th>
                    <th>x</th> <!-- Keeping header as "x" -->
                </tr>
            </thead>
            <tbody>
                 <tr> <!-- 12 Cells -->
                    <td contenteditable="true" spellcheck="false">20BAR 101X*</td>
                    <td contenteditable="true" spellcheck="false">Architectural Thesis / Capstone Project</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">15</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Deep Tech Integration (Chosen tools: GH, AI (Rayan.design?), Fab, Simulation e.g., TRNSYS - Milestone). Advanced Visualization & VR/AR for presentation. BIM Coordination (Navisworks?).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr>
                    <td contenteditable="true" spellcheck="false">20BAR 105</td>
                    <td contenteditable="true" spellcheck="false">Professional Practice</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">Digital Workflows, BIM Standards & Coordination (Navisworks), Collaboration tools (Miro, BIM360?).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L3/Open/Global)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(Two Electives Recommended). Final deep specialization.</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr>
                    <td contenteditable="true" spellcheck="false">20BAR YY EX*</td>
                    <td contenteditable="true" spellcheck="false">Elective* (L3/Open/Global)</td>
                    <td contenteditable="true" data-cell-type="credits" spellcheck="false">3</td>
                     <td class="riba-cell"><select class="riba-select"></select></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="riba-cell"><select class="riba-select"></select></td>
                    <td contenteditable="true" spellcheck="false">*(See above).</td>
                    <td contenteditable="true" spellcheck="false"></td>
                    <td class="delete-cell"><button class="delete-row-button" title="Delete Row">&times;</button></td>
                </tr>
                 <tr class="total-credits-row">
                    <td colspan="2"><strong>Semester 10 Total</strong></td>
                    <td><strong>0</strong></td>
                    <td colspan="9"></td>
                </tr>
            </tbody>
        </table>
        </div><!-- /.table-responsive -->
         <div class="add-course-button-container">
            <button onclick="addCourse('sem10-table')">Add Course to Semester 10</button>
         </div>
         <!-- Unused RIBA Themes Section -->
        <div class="unused-riba-section">
            <p><strong>Unused RIBA Themes in this Semester:</strong> <span id="sem10-unused-riba-list">Calculating...</span></p>
        </div>
    </div>

    <!-- --- RIBA Theme Usage Summary Table --- -->
    <div class="riba-summary-section">
        <h4>RIBA Theme Usage Summary</h4>
        <div class="table-responsive">
            <table id="riba-summary-table">
                <thead>
                    <tr>
                        <th>RIBA Theme</th>
                        <th>Sem 1</th>
                        <th>Sem 2</th>
                        <th>Sem 3</th>
                        <th>Sem 4</th>
                        <th>Sem 5</th>
                        <th>Sem 6</th>
                        <th>Sem 7</th>
                        <th>Sem 8</th>
                        <th>Sem 9</th>
                        <th>Sem 10</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated by JavaScript -->
                </tbody>
            </table>
        </div><!-- /.table-responsive -->
    </div>


    <!-- General Notes Section -->
    <div id="general-notes-section">
        <h4>General Notes</h4>
        <textarea id="general-notes-area" placeholder="Enter any overall notes about the curriculum plan, technology choices, RIBA mapping, or implementation here..." spellcheck="false"></textarea>
    </div>

    <!-- Save Notification -->
    <div id="save-notification" class="save-notification" role="alert"></div>

</div><!-- /.curriculum-planner -->

<script>
    /* --- Start of Refined JavaScript v11 (Fixes ReferenceError, SyntaxError, Dropdowns) --- */
    const ribaThemes = [
        "Health & Life Safety", "Ethics", "Professional Practice", "Structures",
        "Construction", "Resources", "History", "Theory & Methodologies",
        "Design Pedagogies", "Architectural Expression", "Business Skills",
        "Climate Literacy", "Research Literacy"
    ];
     // Updated Key for this version
    const localStorageKey = 'bArchCurriculumData_Nitte_V11yr_RIBA_GD'; // Version 11 key for localStorage fallback

     // Array of semester IDs for easier looping
    const semesterIds = ['sem1', 'sem2', 'sem3', 'sem4', 'sem5', 'sem6', 'sem7', 'sem8', 'sem9', 'sem10'];

    // --- Google Drive Configuration ---
    // ** IMPORTANT: Replace with your actual Google API Client ID **
    const GOOGLE_CLIENT_ID = '168997750221-o31j6hrmavdi9i198nkr7djo28e0ll8j.apps.googleusercontent.com'; // <-- !! REPLACE THIS !!
    // File name to use in Google Drive
    const PLANNER_FILE_NAME = 'BArchCurriculumPlannerData.json';
    // Scopes required for Drive API
    const SCOPES = 'https://www.googleapis.com/auth/drive.file'; // Grants access only to files created or opened by this app

    // --- Google Drive State Variables ---
    let tokenClient; // Google Identity Services client for getting tokens
    let accessToken = null; // Current access token obtained via GSI
    let plannerFileId = null; // ID of the planner file in Google Drive
    let isApiLoaded = false; // Flag to track if the GAPI client and Drive API are loaded

    // --- Autosave Variables ---
    let saveTimerId = null;
    const AUTOSAVE_DELAY_MS = 1500; // 1.5 seconds delay after user stops typing/changing

    // --- UI Elements ---
    const signInButton = document.getElementById('sign-in-button');
    const signOutButton = document.getElementById('sign-out-button');
    const saveToDriveButton = document.getElementById('save-to-drive-button');
    const loadFromDriveButton = document.getElementById('load-from-drive-button');
    const driveStatusElement = document.getElementById('google-drive-status');
    const notificationElement = document.getElementById('save-notification'); // Use the existing notification
    const plannerDiv = document.querySelector('.curriculum-planner'); // Get the main container for delegation

    // --- Helper Functions ---

    // Function to set status message and apply CSS class for color
    function setDriveStatus(message, type = 'info') {
        driveStatusElement.textContent = message;
        // Remove all specific color classes
        driveStatusElement.classList.remove('error', 'success', 'unsaved');
        // Add the appropriate class based on type
        if (type && type !== 'info') { // 'info' uses the default color
            driveStatusElement.classList.add(type);
        }
        console.log(`[Drive Status] ${message} (Type: ${type})`); // Keep console log for debugging
    }


     // Show Save/Error Notification (Reusing the existing one)
     function showNotification(message, isError = false, isInfo = false) {
         console.log(`[Notification] ${message} (Error: ${isError}, Info: ${isInfo})`); // Debug log
         notificationElement.textContent = message;
         notificationElement.classList.remove('error', 'info', 'show'); // Remove previous states

         if (isError) {
             notificationElement.classList.add('error');
         } else if (isInfo) {
             notificationElement.classList.add('info');
         }
         notificationElement.classList.add('show');

         // Hide after 3 seconds
         if (notificationElement._timer) clearTimeout(notificationElement._timer);
         notificationElement._timer = setTimeout(() => {
             notificationElement.classList.remove('show');
         }, 3000);
     }


    // --- Google Identity Services Initialization Callback ---
    // This function MUST be in the global scope (attached to window)
    // so the async GSI script's onload attribute can call it.
    window.gisLoaded = function() {
         console.log("gisLoaded callback fired. Initializing token client..."); // Debug log
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: SCOPES,
            callback: handleGsiCallback, // Use the dedicated callback
            prompt: '', // Request permissions explicitly when calling requestAccessToken
        });
         console.log("GIS client initialized.");
         // Initial status update will happen after GAPI loads as well in onApiLoadComplete
    }

    // Dedicated callback for the GSI token client (called by gisLoaded or tokenClient.requestAccessToken)
    function handleGsiCallback(resp) {
        console.log("handleGsiCallback fired with response:", resp); // Debug log
        if (resp.error) {
            // Handle authorization errors (user denied access, etc.)
            console.error('Authorization error:', resp.error);
             let statusMessage = "Sign-in failed.";
             let statusType = 'error';
             if (resp.error === 'popup_closed_by_user') {
                  statusMessage = "Google sign-in popup closed.";
                  statusType = 'info';
             } else if (resp.error === 'access_denied') {
                 statusMessage = "Access to Google Drive denied.";
                  showNotification("Access to Google Drive denied. Cannot save/load.", true);
             } else {
                  statusMessage = `Sign-in error: ${resp.error_description || resp.error}`;
                 showNotification(`Google Sign-in failed: ${resp.error_description || resp.error}`, true);
             }
             setDriveStatus(statusMessage, statusType);


            accessToken = null;
            gapi.client.setToken(null); // Ensure gapi client token is cleared
            updateSignInStatus(); // Update buttons and final status message
            cancelScheduledAutosave(); // Cancel any pending autosave if auth fails
            return;
        }

        // Authorization successful
        accessToken = resp.access_token;
        gapi.client.setToken({ access_token: accessToken }); // Set the token for gapi.client
        console.log("Successfully signed in. Access Token obtained."); // Debug log

        // Status will be updated to success/searching by onApiLoadComplete or findOrCreatePlannerFile
        updateSignInStatus(); // Update buttons immediately

        // If the API is already loaded, we can proactively find/create the file ID
        // Otherwise, the check will run later when onApiLoadComplete fires.
        if (isApiLoaded && !plannerFileId) {
            console.log("Signed in and API loaded, but file ID unknown. Searching/creating file..."); // Debug log
            // Don't await here, let it run in the background or chain Promises if needed
             findOrCreatePlannerFile().catch(err => {
                 console.error("Error finding/creating file after sign-in:", err);
                 // Status/notification already handled by findOrCreatePlannerFile
             });
        } else if (isApiLoaded && plannerFileId) {
             // If already signed in and file ID known, just update status to confirm readiness
             setDriveStatus("Signed in. Planner file ready.", 'success');
        }
        // If API is not yet loaded, the find/create will happen later in onApiLoadComplete if signed in.
        console.log("handleGsiCallback finished.");
    }


    // --- Google API Client Library Initialization Callback ---
    // This function MUST be in the global scope (attached to window)
    // so the async GAPI script's onload attribute can call it.
    window.gapiLoaded = function() {
         console.log("gapiLoaded callback fired. Loading client library..."); // Debug log
        gapi.load('client', initializeGapiClient);
        console.log("GAPI client library load requested.");
    }

    function initializeGapiClient() {
        console.log("initializeGapiClient function called. Initializing gapi.client..."); // Debug log
        // Initialize the client library (no API key needed for OAuth flows)
        gapi.client.init({})
            .then(() => {
                console.log("GAPI client core initialized. Loading Drive API..."); // Debug log
                return gapi.client.load('drive', 'v3'); // Load Drive v3 API
            })
             .then(() => {
                 // Drive API is loaded!
                 console.log("Google Drive API v3 loaded successfully."); // Debug log
                 isApiLoaded = true; // Set the flag

                 // Now that both client and Drive API are loaded:
                 onApiLoadComplete(); // Call the function to handle post-load setup

             })
            .catch((error) => {
                console.error("Error initializing GAPI client or loading Drive API:", error); // Debug log
                 setDriveStatus("Error initializing Google Drive.", 'error');
                 showNotification("Could not initialize Google Drive integration.", true);
                 isApiLoaded = false; // Ensure flag is false on failure
                 updateSignInStatus(); // Update buttons based on failure
            });
    }

    // Actions to perform once GSI token client is ready AND GAPI client + Drive API are loaded
    function onApiLoadComplete() {
         console.log("onApiLoadComplete called. Setting up..."); // Debug log
        // Setup listeners for Google Drive buttons now that GAPI is loaded
        setupButtonListeners();

        // Attempt to load file ID from localStorage
        plannerFileId = localStorage.getItem(`${localStorageKey}_fileId`);
        console.log("Initial plannerFileId check from localStorage (onApiLoadComplete):", plannerFileId); // Debug log

        // Update buttons based on current sign-in state (if any) and API loaded status
        updateSignInStatus();

        // If already signed in (e.g., page reload after auth), and API is loaded but file ID unknown, find/create it now
         if (accessToken && isApiLoaded && !plannerFileId) {
             console.log("API loaded, signed in, but file ID unknown. Searching/creating file..."); // Debug log
             // Don't await here, let it run in the background or chain Promises if needed
             findOrCreatePlannerFile().catch(err => {
                  console.error("Error finding/creating file after API load:", err);
                  // Status/notification already handled by findOrCreatePlannerFile
             });
         } else if (accessToken && isApiLoaded && plannerFileId) {
              // If already signed in and file ID known, just update status to confirm readiness
              setDriveStatus("Signed in. Planner file ready.", 'success');
         } else if (isApiLoaded) {
             // Not signed in, API is loaded. Prompt user to sign in.
             setDriveStatus("Google Drive ready. Sign in to load/save.", 'info');
         }
         // else { // !isApiLoaded, status remains "Loading Google API..." from initialLoad
         // }
         console.log("onApiLoadComplete finished."); // Debug log
    }


    // --- Handle Google Sign-in/Sign-out ---
     function handleAuthClick() {
         console.log("Sign In button clicked. Attempting authorization..."); // Debug log
         if (!tokenClient) {
             console.error("Token client not initialized when trying to sign in."); // Debug log
              setDriveStatus("Google Sign-in not ready.", 'error');
              showNotification("Google Sign-in is not ready. Please refresh.", true);
              return;
         }
         // We can request auth even if API is not fully loaded, as the callback will handle the API load state.
         setDriveStatus("Signing in...", 'info');
         // requestAccessToken will trigger the handleGsiCallback upon completion
         tokenClient.requestAccessToken();
     }

    function handleSignoutClick() {
        console.log("Sign Out button clicked."); // Debug log
        if (accessToken) {
             // Google Identity Services doesn't have a synchronous 'signOut' like gapi.auth2
             // Setting the token to null effectively signs out the current session for gapi.client
             gapi.client.setToken(null);
             accessToken = null;
             // We *don't* clear plannerFileId or localStorage here, as the file still exists,
             // it's just that *this user* is no longer signed in. Another user on the same
             // computer might sign in and need the same file ID.
             // plannerFileId = null; // DECISION: Keep the file ID
             // localStorage.removeItem(`${localStorageKey}_fileId`); // DECISION: Keep the file ID in local storage

             setDriveStatus("Signed out.", 'info');
             console.log("Successfully signed out."); // Debug log
             updateSignInStatus(); // Disable buttons
             showNotification("Signed out of Google Drive.", false, true); // Info notification
        } else {
             console.log("Sign Out clicked but no access token was active."); // Debug log
             setDriveStatus("Already signed out.", 'info');
        }
         cancelScheduledAutosave(); // Cancel any pending autosave
    }

    // --- UI Update Functions ---
    function updateSignInStatus() {
        const signedIn = !!accessToken;
        // The isApiLoaded flag now correctly represents if gapi.client.drive is ready
        const apiReady = isApiLoaded;

        signInButton.hidden = signedIn;
        signOutButton.hidden = !signedIn;

        // Enable Save/Load buttons only when signed in AND API is loaded
        saveToDriveButton.disabled = !(signedIn && apiReady);
        loadFromDriveButton.disabled = !(signedIn && apiReady);
        // Hide buttons until API is loaded, regardless of sign-in state
        saveToDriveButton.hidden = !apiReady;
        loadFromDriveButton.hidden = !apiReady;


        // Update the status message, unless it's currently showing "Unsaved changes..."
        // This prevents the autosave status from being overwritten prematurely.
        if (!saveTimerId) { // Only update status if no autosave is pending
             if (!apiReady) {
                 setDriveStatus("Loading Google API...");
             } else if (!signedIn) {
                 setDriveStatus("Google Drive ready. Sign in to load/save.", 'info');
             } else if (!plannerFileId) {
                  // Signed in, API loaded, but file ID unknown (should be resolved by findOrCreate after sign-in/load)
                  setDriveStatus("Signed in. Searching for planner file...", 'info');
             } else {
                 // Signed in, API loaded, File ID known
                 setDriveStatus("Planner file ready.", 'success'); // Could refine this based on last save time?
             }
        }
         // Else: status remains "Unsaved changes..." set by scheduleAutosave

         console.log(`Update Sign In Status: SignedIn=${signedIn}, ApiReady=${apiReady}, FileIdPresent=${!!plannerFileId}, SavePending=${!!saveTimerId}`); // Debug log
    }

     // --- Google Drive File Management Functions ---

    /**
     * Searches for the planner file by name. If not found, creates it.
     * Stores the file ID in plannerFileId and localStorage.
     * Returns a Promise that resolves with the file ID.
     */
    async function findOrCreatePlannerFile() {
        console.log("findOrCreatePlannerFile called."); // Debug log
        if (plannerFileId) {
            console.log("File ID already known:", plannerFileId); // Debug log
            // Update status to success only if not already showing "Unsaved changes..."
            if (!saveTimerId) {
                 setDriveStatus("Planner file ready.", 'success');
            }
            return plannerFileId; // Use cached ID
        }

        if (!accessToken) {
            console.warn("findOrCreatePlannerFile: Not signed in. Cannot find or create file."); // Debug log
             setDriveStatus("Cannot find/create file: Not signed in.", 'info');
             updateSignInStatus(); // Revert status to 'Sign in...'
             return null; // Return null when not signed in
        }
        if (!isApiLoaded || !gapi?.client?.drive) {
             console.error("findOrCreatePlannerFile: GAPI Drive client not ready."); // Debug log
            setDriveStatus("Cannot find/create file: Google Drive API not loaded.", 'error');
            throw new Error("Google Drive API client not initialized."); // Should be caught by outer checks
        }

        setDriveStatus(`Searching for "${PLANNER_FILE_NAME}"...`, 'info');

        try {
            // Search for the file by name and MIME type
            const response = await gapi.client.drive.files.list({
                q: `name='${PLANNER_FILE_NAME}' and mimeType='application/json' and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive',
                pageSize: 1 // We only expect one such file
            });

            const files = response.result.files;

            if (files && files.length > 0) {
                // File found
                plannerFileId = files[0].id;
                localStorage.setItem(`${localStorageKey}_fileId`, plannerFileId);
                // Only update status to success if not currently showing "Unsaved changes..."
                if (!saveTimerId) {
                     setDriveStatus(`Found planner file: "${files[0].name}".`, 'success');
                } else {
                     // If unsaved changes are pending, keep that status
                     setDriveStatus("Unsaved changes...", 'unsaved');
                }
                console.log("Found existing planner file:", plannerFileId); // Debug log
                return plannerFileId;
            } else {
                // File not found, create it
                setDriveStatus(`"${PLANNER_FILE_NAME}" not found. Creating new file...`, 'info');
                 console.log("File not found. Attempting to create."); // Debug log
                const createResponse = await gapi.client.drive.files.create({
                    resource: {
                        name: PLANNER_FILE_NAME,
                        mimeType: 'application/json'
                    },
                    fields: 'id, name', // Request the ID and name of the created file
                });

                plannerFileId = createResponse.result.id;
                localStorage.setItem(`${localStorageKey}_fileId`, plannerFileId);
                // Status update after creation - might be unsaved state if autosave triggered creation
                 if (!saveTimerId) {
                     setDriveStatus(`Created new planner file: "${createResponse.result.name}".`, 'success');
                 } else {
                     setDriveStatus("Unsaved changes...", 'unsaved');
                 }

                console.log("Created new planner file:", plannerFileId); // Debug log
                return plannerFileId;
            }
        } catch (error) {
            console.error("Error finding or creating file:", error); // Debug log
            const errorMessage = error.result?.error?.message || error.body?.error?.message || error.message || "Unknown error";
             setDriveStatus(`Error finding/creating file: ${errorMessage}`, 'error');
            updateSignInStatus(); // Ensure buttons/status reflect failure
            // Decide whether to throw or return null. Throwing might be better for callers expecting an ID on success.
            throw new Error(`Could not find or create planner file: ${errorMessage}`); // Propagate error
        }
        // No finally block needed here, status is set inside try/catch
    }

     /**
      * Saves the current planner data to the file in Google Drive.
      * This function is called by manual save or the autosave timer.
      */
    async function saveDataToDrive() {
        console.log("saveDataToDrive called."); // Debug log
        cancelScheduledAutosave(); // Ensure any pending autosave is cleared before *this* save starts

        if (!accessToken || !isApiLoaded) {
             console.warn("Save attempted when not signed in or API not loaded.");
             setDriveStatus("Cannot save: Not signed in or Google Drive not ready.", 'info');
            return; // Stop execution
        }

        // Show saving status/notification
        setDriveStatus("Saving...", 'info');
        showNotification("Saving to Google Drive...", false, true); // Info notification

        try {
            // findOrCreatePlannerFile also checks accessToken/isApiLoaded internally
            const fileId = await findOrCreatePlannerFile(); // Ensure file exists and ID is known
             if (!fileId) {
                  // findOrCreatePlannerFile should have set an error status, just exit
                  console.error("Save failed: File ID not available after findOrCreateFile.");
                 throw new Error("File ID not available for saving.");
             }
              console.log("Saving data to file ID:", fileId); // Debug log

            const data = collectPlannerData(); // Collect data from the page
            const jsonContent = JSON.stringify(data, null, 2); // Stringify with formatting

            // Construct multipart body for updating file content
            const boundary = '-------314159265358979323846';
            const delimiter = "\r\n--" + boundary + "\r\n";
            const closeDelimiter = "\r\n--" + boundary + "--";

            // The metadata part is required but can be empty if no metadata is being updated
            const metadata = {};

            let multipartRequestBody =
                delimiter +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' + // Metadata part
                JSON.stringify(metadata) +
                delimiter +
                'Content-Type: application/json; charset=UTF-8\r\n\r\n' + // File content part
                jsonContent +
                closeDelimiter;

             console.log("Sending PATCH request to Drive API..."); // Debug log
            const response = await gapi.client.request({
                path: '/upload/drive/v3/files/' + fileId,
                method: 'PATCH',
                params: {
                    uploadType: 'multipart' // Indicate multipart upload
                },
                headers: {
                    'Content-Type': 'multipart/related; boundary="' + boundary + '"'
                     // GAPI client handles Authorization header automatically with gapi.client.setToken
                },
                body: multipartRequestBody
            });

            console.log("Save successful:", response); // Debug log
            showNotification("Planner saved to Google Drive!", false); // Success notification
            setDriveStatus("Saved successfully.", 'success');

        } catch (error) {
            console.error("Error saving to Google Drive:", error); // Debug log
             // GAPI errors often have structured responses
             const errorMessage = error.result?.error?.message || error.body?.error?.message || error.message || "Unknown error";
             showNotification(`Error saving to Drive: ${errorMessage}`, true); // Error notification
            setDriveStatus(`Save failed: ${errorMessage}`, 'error');
             // If the error is authentication related, prompt sign-in
             if (error.status === 401 || error.status === 403) { // Unauthorized or Forbidden
                  setDriveStatus("Authentication required or expired. Please sign in again.", 'info');
                  // Potentially auto-trigger sign-in here if this was an autosave attempt?
                  // handleAuthClick(); // Maybe too aggressive for autosave failure
             }
        } finally {
             // updateSignInStatus(); // Not needed here, status is set by success/error calls
             console.log("saveDataToDrive finished.");
        }
    }

     /**
      * Loads planner data from the file in Google Drive.
      */
    async function loadDataFromDrive() {
        console.log("loadDataFromDrive called."); // Debug log
        if (!accessToken) {
            showNotification("Please sign in to Google Drive first.", false, true); // Info, not error
            handleAuthClick(); // Prompt sign-in
            return; // Stop execution until signed in
        }
         if (!isApiLoaded) {
             showNotification("Google Drive API is not loaded yet.", false, true); // Info
             setDriveStatus("Please wait for Google Drive to load.", 'info');
             return;
         }

         showNotification("Loading from Google Drive...", false, true); // Info notification
         setDriveStatus("Loading...", 'info');
         loadFromDriveButton.disabled = true; // Disable button during load
         cancelScheduledAutosave(); // Cancel any pending autosave before loading


        try {
            const fileId = await findOrCreatePlannerFile(); // Ensure file exists and ID is known
             if (!fileId) {
                  console.error("Load failed: File ID not available after findOrCreateFile.");
                 throw new Error("File ID not available for loading.");
             }
              console.log("Loading data from file ID:", fileId); // Debug log

            // Get file content using alt=media parameter
            console.log("Sending GET request to Drive API for file content..."); // Debug log
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media' // Specify that we want the file content
            });

            // The response.result directly contains the JSON parsed object for alt=media
            const loadedData = response.result;
            console.log("Load successful:", loadedData); // Debug log

            // Apply the loaded data to the page
            applyPlannerData(loadedData);

             showNotification("Planner loaded from Google Drive!", false); // Success notification
             setDriveStatus("Loaded successfully.", 'success');

        } catch (error) {
            console.error("Error loading from Google Drive:", error); // Debug log
             const errorMessage = error.result?.error?.message || error.body?.error?.message || error.message || "Unknown error";
             showNotification(`Error loading from Drive: ${errorMessage}`, true); // Error notification
            setDriveStatus(`Load failed: ${errorMessage}`, 'error');
             // If the error is authentication related, prompt sign-in
              if (error.status === 401 || error.status === 403) { // Unauthorized or Forbidden
                  setDriveStatus("Authentication required or expired. Please sign in again.", 'info');
             }
        } finally {
             loadFromDriveButton.disabled = false; // Re-enable button
             updateSignInStatus(); // Ensure buttons are correctly enabled/disabled
             console.log("loadDataFromDrive finished.");
             // No autosave needed immediately after loading - user hasn't made changes yet.
        }
    }


 // --- Data Collection and Application Functions ---

 // Collects all data from the HTML planner into a JSON object
 function collectPlannerData() {
    console.log("collectPlannerData called."); // Debug log
    const data = {
        // Use a version flag in data for potential future format changes
        version: 11, // Increment version
        semesters: {},
        summaries: {},
        generalNotes: document.getElementById('general-notes-area')?.value ?? "" // Use .value for textarea, handle null element
    };

    semesterIds.forEach(semId => {
        const tableId = `${semId}-table`;
        const table = document.getElementById(tableId);
        if (!table) {
             console.warn(`Table element not found for semester ${semId} during data collection. Skipping.`);
             return;
         }

        const tbody = table.getElementsByTagName('tbody')[0];
         if(!tbody) {
             console.warn(`Table body not found for semester ${semId} during data collection. Skipping.`);
             return;
         }

        // Select rows that are not the total row, ensuring they are actual table rows
        const rows = tbody.querySelectorAll('tr:not(.total-credits-row)');
        const semesterData = [];
        rows.forEach(row => {
            const cells = row.getElementsByTagName('td');
             if (cells.length < 12) { // Ensure we have expected number of cells
                  console.warn(`Skipping row in ${tableId} due to unexpected number of cells (${cells.length})`, row);
                  return;
             }
            // Capture data from the first 11 cells (indices 0-10)
            const course = {
                code: cells[0].textContent ?? "", // Text field
                title: cells[1].textContent ?? "", // Text field
                credits: cells[2].textContent ?? "0", // Text field (string) - default to "0"
                defaultRibaTheme: cells[3].querySelector('select.riba-select')?.value ?? "", // Select value
                acadRibaDirect: cells[4].querySelector('select.riba-select')?.value ?? "", // Select value
                academicNotes: cells[5].innerHTML ?? "", // innerHTML for multi-line notes
                ethicsRibaDirect: cells[6].querySelector('select.riba-select')?.value ?? "", // Select value
                ethicsNotes: cells[7].innerHTML ?? "", // innerHTML for multi-line notes
                techRibaDirect: cells[8].querySelector('select.riba-select')?.value ?? "",  // Select value
                techNotes: cells[9].innerHTML ?? "", // innerHTML for multi-line notes
                remarks: cells[10].innerHTML ?? "" // innerHTML for multi-line remarks
            };
            semesterData.push(course);
        });
        data.semesters[semId] = semesterData;

        // Save Summary Data (innerHTML)
        const summaryElement = document.getElementById(`${semId}-summary`);
        if (summaryElement) {
            data.summaries[semId] = summaryElement.innerHTML ?? ""; // Use innerHTML for summary
        } else {
             console.warn(`Summary element not found for semester ${semId} during data collection. Skipping.`);
        }
    });
     console.log("Collected Planner Data:", data); // Debug log
    return data;
 }

 // Applies loaded data to the HTML planner
 // forceDefault = true can be used to re-initialize the UI to its default HTML state.
 function applyPlannerData(data, forceDefault = false) {
    console.log(`Applying Planner Data (forceDefault: ${forceDefault}):`, data); // Debug log

    if (!data || typeof data !== 'object' || forceDefault) {
        if (!forceDefault) console.warn("No valid data provided to apply, or forceDefault is true. Initializing default HTML structure.");
        // If no data or forced default, clear current content and re-initialize default UI.
        // Clearing content might be tricky if we want to preserve the original HTML structure.
        // A better approach is to clear dynamically added rows and then re-initialize based on current DOM.

        // Reset general notes to empty or default
        const generalNotesArea = document.getElementById('general-notes-area');
        if(generalNotesArea) generalNotesArea.value = "";

        // Clear dynamic rows and summaries, then re-initialize everything below
        semesterIds.forEach(semId => {
            const table = document.getElementById(`${semId}-table`);
            const summaryElement = document.getElementById(`${semId}-summary`);

            if (table) {
                const tbody = table.getElementsByTagName('tbody')[0];
                if(tbody) {
                     // Remove ALL rows except the header and total row
                     // Find default rows to keep them? Or assume all rows in tbody *except* total are data rows?
                     // Let's assume any row that isn't total-credits-row should be cleared if loading from file.
                     // If forceDefault=true, we want to keep the original HTML rows. This function needs adjustment.

                     // Okay, rethinking: applyPlannerData should only *add* rows from loaded data.
                     // The *calling* code (initialLoad) should handle clearing the existing rows
                     // based on whether it successfully loaded data or is falling back to default HTML.
                     // Let's revert applyPlannerData to *only* add rows and summaries.
                     // And modify initialLoad to clear *before* calling applyPlannerData if data IS loaded.
                }
            }
             // If summary was editable, clear its content if needed?
             // if (summaryElement) summaryElement.innerHTML = ""; // Or revert to original default text?
        });

        // If we were meant to load data but failed, we now have the default HTML structure.
        // We still need to initialize selects and run calculations for this structure.
        initializeAllRibaDropdowns();
        calculateAllSemestersCredits();
        calculateAllSemestersUnusedRiba();
        updateRibaSummaryTable();

        console.log("Apply data finished. UI initialized/reset.");
        return; // Stop here if no valid data or forced default
    }

    // --- Logic for applying VALID loaded data ---
    console.log("Applying loaded data...");

    // Apply general notes
    const generalNotesArea = document.getElementById('general-notes-area');
    if (generalNotesArea && data.generalNotes !== undefined) { // Check specifically for undefined to allow empty string
        generalNotesArea.value = data.generalNotes;
    } else if (generalNotesArea) {
         generalNotesArea.value = ""; // Clear if data is missing notes property
         console.warn("General notes data missing or undefined in loaded data.");
    }


    // Apply semester data
    semesterIds.forEach(semId => {
        const tableId = `${semId}-table`;
        const table = document.getElementById(tableId);
         const summaryElement = document.getElementById(`${semId}-summary`);

        if (!table) {
             console.warn(`Table element not found for semester ${semId}. Skipping application.`);
             return;
         }

        const tbody = table.getElementsByTagName('tbody')[0];
         if(!tbody) {
             console.error(`Table body not found for semester ${semId}. Skipping application.`);
             return;
         }

        // CLEAR existing data rows before adding loaded data rows
         // Assume any row that is NOT the total-credits-row AND is NOT a header row (tbody has no headers)
         // is a data row that should be replaced by the loaded data.
         const existingRows = tbody.querySelectorAll('tr:not(.total-credits-row)');
         existingRows.forEach(row => row.remove());
         console.log(`Cleared existing rows for ${tableId} before applying loaded data.`); // Debug log


        if (data.semesters && data.semesters[semId] && Array.isArray(data.semesters[semId])) {
            console.log(`Loading ${data.semesters[semId].length} courses for ${semId}.`); // Debug log
             data.semesters[semId].forEach(course => {
                 // Add rows from data WITHOUT triggering autosave immediately for each row
                 addCourseRowToTable(tableId, course); // Use the row adding helper
             });
        } else {
            console.warn(`No course data found for ${semId} in the loaded data. Semester will be empty.`); // Debug log
        }

        // Apply Summary Data (innerHTML)
        if (summaryElement && data.summaries && data.summaries[semId] !== undefined) { // Check for undefined
             summaryElement.innerHTML = data.summaries[semId];
             // console.log(`Applied summary for ${semId}.`); // Debug log
        } else if (summaryElement) {
             console.warn(`No summary data found for ${semId} or data missing in loaded data. Keeping default HTML summary.`); // Debug log
             // If no summary data in the file, the original HTML summary remains from initial DOM load.
        }
    });

     // Recalculate everything after applying data to ensure UI consistency
     console.log("Applying data complete. Recalculating totals, unused, and summary."); // Debug log
     // These functions will operate on the DOM state *after* data is applied,
     // handling either loaded rows or an empty state if no data was loaded for a semester.
     initializeAllRibaDropdowns(); // Re-populate ALL selects (loaded rows + default HTML rows if any weren't cleared - though they should be)
     calculateAllSemestersCredits();
     calculateAllSemestersUnusedRiba(); // This calls calculateUnusedRiba for each sem
     updateRibaSummaryTable(); // This rebuilds the summary table

      console.log("applyPlannerData finished.");
      // Important: Do *not* schedule autosave immediately after applying loaded data.
      // Autosave should only trigger on *user* modifications after the load is complete.
      // The event listeners added in setupGlobalEventListeners will handle this.
 }


// --- Populate RIBA Dropdowns ---
// Populates a single select element.
function populateRibaSelect(selectElement, selectedValue = "") {
    // Store current value if it exists, defaulting to "" if null/undefined
    const currentValue = selectedValue ?? selectElement.value ?? "";
    // console.log(`Populating select. Initial value: "${currentValue}"`); // Debug log

    // Clear existing options
    selectElement.innerHTML = '';

    // Add a default "Select" option
    const defaultOption = document.createElement('option');
    defaultOption.value = "";
    defaultOption.textContent = "Select";
    selectElement.appendChild(defaultOption);

    // Add RIBA themes
    ribaThemes.forEach(theme => {
        const option = document.createElement('option');
        option.value = theme;
        option.textContent = theme;
        selectElement.appendChild(option);
    });

    // Set the selected value after populating
    // Ensure the value is actually one of the options, otherwise default to "Select"
     if (currentValue !== "" && selectElement.querySelector(`option[value="${currentValue}"]`)) {
          selectElement.value = currentValue;
          // console.log(`Select value set to "${currentValue}".`); // Debug log
     } else {
          selectElement.value = ""; // Default to "Select" if value is null, empty, or invalid
           if (currentValue !== "") {
                // console.warn(`Could not set select value to "${currentValue}" (Option not found). Defaulting to "Select".`); // Debug log
           } else {
                // console.log("Select value defaulted to 'Select' (Initial value was empty)."); // Debug log
           }
     }
}

// Function to initialize dropdowns for *all* selects currently in the DOM
 // Called after initial DOM load or after applying loaded data.
 function initializeAllRibaDropdowns() {
    console.log("initializeAllRibaDropdowns called."); // Debug log
    const allSelects = document.querySelectorAll('select.riba-select');
    console.log(`Found ${allSelects.length} RIBA dropdowns to initialize.`); // Debug log
    allSelects.forEach(select => {
        // The value attribute might have been set by addCourseRowToTable
        // The .value property might reflect the current state if it was an existing HTML element
        // Prioritize the 'value' attribute if it exists, otherwise use the .value property
        const initialValue = select.getAttribute('value') ?? select.value ?? "";
        populateRibaSelect(select, initialValue);
         // Remove value attribute after populating to prevent confusion later
         select.removeAttribute('value');
    });
     console.log("initializeAllRibaDropdowns finished."); // Debug log
 }


// --- Calculate Semester Credits ---
function calculateSemesterCredits(tableId) {
    // console.log(`calculateSemesterCredits called for ${tableId}`); // Debug log
    const table = document.getElementById(tableId);
    if (!table) {
         console.warn(`Table not found for credit calculation: ${tableId}`);
         return;
    }
    const tbody = table.getElementsByTagName('tbody')[0];
    if (!tbody) {
        console.warn(`Table body not found for credit calculation: ${tableId}`);
        return;
    }
    // Select credit cells using the data attribute for robustness
    const creditCells = tbody.querySelectorAll('tr:not(.total-credits-row) td[data-cell-type="credits"]');
    let totalCredits = 0;
    creditCells.forEach(cell => {
        // Use textContent for safety and trim whitespace
        const creditValue = parseInt(cell.textContent.trim()) || 0;
        totalCredits += creditValue;
    });
    const totalCell = tbody.querySelector('tr.total-credits-row td:nth-child(2)'); // The cell displaying the total
    if (totalCell) {
        totalCell.textContent = totalCredits;
         // console.log(`Calculated total credits for ${tableId}: ${totalCredits}`); // Debug log
    } else {
         console.warn("Could not find total credits cell for table:", tableId);
    }
}

 // --- Calculate All Semester Credits ---
 function calculateAllSemestersCredits() {
     console.log("Calculating all semester credits."); // Debug log
    semesterIds.forEach(semId => {
         const tableId = `${semId}-table`;
         // Check if table exists before calculating
         if(document.getElementById(tableId)){
             calculateSemesterCredits(tableId);
         }
     });
      console.log("calculateAllSemestersCredits finished.");
 }

 // --- Calculate and Display Unused RIBA Themes for a Semester ---
 function calculateUnusedRiba(tableId) {
     // console.log(`calculateUnusedRiba called for ${tableId}`); // Debug log
     const table = document.getElementById(tableId);
     if (!table) {
         console.warn(`Table not found for unused RIBA calculation: ${tableId}`);
         return;
     }
     const tbody = table.getElementsByTagName('tbody')[0];
      if (!tbody) {
          console.warn(`Table body not found for unused RIBA calculation: ${tableId}`);
          return;
      }

     // Find the span element where the list should be displayed
     const unusedListId = tableId.replace('-table', '-unused-riba-list');
     const unusedListElement = document.getElementById(unusedListId);
     if (!unusedListElement) {
         console.warn(`Could not find unused RIBA list element with ID: ${unusedListId}`);
         return;
     }

     // Get all selected RIBA themes in this table
     // Selects are in columns 3, 4, 6, 8 (0-indexed are 3, 4, 6, 8) - these indices match the CSS
     // Ensure we only look within tbody and not the total row
     const selectElements = tbody.querySelectorAll('tr:not(.total-credits-row) td:nth-child(4) select, tr:not(.total-credits-row) td:nth-child(5) select, tr:not(.total-credits-row) td:nth-child(7) select, tr:not(.total-credits-row) td:nth-child(9) select');
     const usedThemes = new Set();

     selectElements.forEach(select => {
         const value = select.value.trim();
         // Only add if a theme is actually selected AND it's one of the valid themes
         if (value !== "" && ribaThemes.includes(value)) {
             usedThemes.add(value);
         }
     });

     // Determine unused themes
     const unusedThemes = ribaThemes.filter(theme => !usedThemes.has(theme));

     // Update the display
     if (unusedThemes.length === 0) {
         unusedListElement.textContent = "All RIBA themes used!";
     } else {
         unusedListElement.textContent = unusedThemes.join(', ');
     }
      // console.log(`Unused RIBA themes for ${tableId}: ${unusedThemes.length === 0 ? 'None' : unusedThemes.join(', ')}`); // Debug log
 }

// --- Calculate All Semester Unused RIBA Themes ---
function calculateAllSemestersUnusedRiba() {
    console.log("Calculating all semester unused RIBA themes."); // Debug log
    semesterIds.forEach(semId => {
         const tableId = `${semId}-table`;
          // Check if table exists before calculating
          if(document.getElementById(tableId)){
              calculateUnusedRiba(tableId);
          }
     });
     console.log("calculateAllSemestersUnusedRiba finished.");
}

// --- Update RIBA Summary Table ---
function updateRibaSummaryTable() {
    console.log("Updating RIBA Summary Table."); // Debug log
    const summaryTable = document.getElementById('riba-summary-table');
    if (!summaryTable) {
         console.error("RIBA summary table not found.");
         return;
    }
    const summaryTableBody = summaryTable.getElementsByTagName('tbody')[0];
    if (!summaryTableBody) {
        console.error("RIBA summary table body not found.");
        return;
    }


    // Clear existing content
    summaryTableBody.innerHTML = '';

    // Initialize counts structure { theme: { sem1: 0, sem2: 0, ..., sem10: 0, total: 0 } }
    const themeCounts = {};
    ribaThemes.forEach(theme => {
        themeCounts[theme] = { total: 0 };
        semesterIds.forEach(semId => {
            themeCounts[theme][semId] = 0;
        });
    });

    // Iterate through each semester table
    semesterIds.forEach(semId => {
        const table = document.getElementById(`${semId}-table`);
        if (!table) {
             console.warn(`Source table not found for summary calculation: ${semId}. Skipping.`);
             return;
        }
         const tbody = table.getElementsByTagName('tbody')[0];
          if (!tbody) {
               console.warn(`Source table body not found for summary calculation: ${semId}. Skipping.`);
               return;
          }

        const rows = tbody.querySelectorAll('tr:not(.total-credits-row)');

        // Iterate through each course row in the semester
        rows.forEach(row => {
            // Selects are in columns 3, 4, 6, 8 (0-indexed)
            const selectElements = [
                 row.cells[3]?.querySelector('select.riba-select'),
                 row.cells[4]?.querySelector('select.riba-select'),
                 row.cells[6]?.querySelector('select.riba-select'),
                 row.cells[8]?.querySelector('select.riba-select'),
            ].filter(select => select != null); // Filter out nulls if cell/select not found

             selectElements.forEach(select => {
                const selectedTheme = select.value.trim();
                // Only count if a theme is selected and it's a valid RIBA theme
                if (selectedTheme !== "" && ribaThemes.includes(selectedTheme)) {
                     if (themeCounts[selectedTheme]) { // Check if theme exists in our counts structure
                          themeCounts[selectedTheme][semId]++;
                          themeCounts[selectedTheme].total++;
                     } else {
                         // This case should ideally not happen if ribaThemes is comprehensive
                         console.warn(`Unexpected theme selected in summary count: "${selectedTheme}"`);
                     }
                }
            });
        });
    });

    // Populate the summary table body
    ribaThemes.forEach(theme => {
        const row = document.createElement('tr');

        // Theme name cell (sticky left)
        const themeCell = document.createElement('td'); // Using td for content, th in header
        themeCell.textContent = theme;
        row.appendChild(themeCell);

        // Counts per semester
        semesterIds.forEach(semId => {
            const countCell = document.createElement('td');
            countCell.textContent = themeCounts[theme][semId] || 0; // Display count, default to 0
            row.appendChild(countCell);
        });

        // Total count cell
        const totalCell = document.createElement('td');
        totalCell.textContent = themeCounts[theme].total || 0; // Display total count, default to 0
        totalCell.style.fontWeight = 'bold'; // Make total count bold
        totalCell.style.color = 'var(--primary-dark)'; // Highlight total
        row.appendChild(totalCell);

        summaryTableBody.appendChild(row);
    });
     console.log("RIBA Summary Table updated."); // Debug log
}


// --- Add Course Functionality ---
// Renamed to clearly indicate it adds the row DOM element
// Autosave triggered separately by event listeners after the row is added
function addCourseRowToTable(tableId, courseData = null) {
    const table = document.getElementById(tableId);
    if (!table) {
         console.error(`Attempted to add course to non-existent table: ${tableId}`);
         return null; // Return null on failure
    }
    const tbody = table.getElementsByTagName('tbody')[0];
     if(!tbody) {
         console.error(`Table body not found for table: ${tableId}`);
         return null; // Return null on failure
     }
    const totalRow = tbody.querySelector('.total-credits-row');
    const newRow = document.createElement('tr');
    console.log(`Adding new course row to ${tableId}. Data:`, courseData); // Debug log

    // Helper to create cells - handles 12 columns (11 data + 1 delete)
    // Using ?? '' for null/undefined checks
    const createCell = (content = "", isEditable = true, cellIndex, type = 'text') => {
        const cell = document.createElement('td');
        cell.setAttribute('spellcheck', 'false'); // Disable spellcheck for all editable cells

        if (type === 'select') {
            cell.classList.add('riba-cell');
            const select = document.createElement('select');
            select.classList.add('riba-select');
            select.setAttribute('value', content ?? ''); // Set initial value as attribute for populateRibaSelect
            cell.appendChild(select);
            cell.setAttribute('contenteditable', 'false'); // Selects are not contenteditable
        } else if (type === 'delete') {
             cell.classList.add('delete-cell');
             const deleteButton = document.createElement('button');
             deleteButton.classList.add('delete-row-button');
             deleteButton.innerHTML = '&times;';
             deleteButton.title = 'Delete Row';
             cell.appendChild(deleteButton);
             cell.setAttribute('contenteditable', 'false'); // Button cell is not contenteditable
        }
         else { // Text or rich content editable cells
             cell.setAttribute('contenteditable', isEditable ? 'true' : 'false');

             // Use innerHTML for notes/remarks/summaries to preserve formatting
             if (isEditable && (cellIndex === 5 || cellIndex === 7 || cellIndex === 9 || cellIndex === 10)) {
                 cell.innerHTML = content ?? ''; // Use innerHTML directly as collected
             } else if (cellIndex === 2 && isEditable) {
                 // Credits cell: use textContent, mark type
                 cell.textContent = content ?? '';
                 cell.setAttribute('data-cell-type', 'credits'); // Mark credits cell
             }
             else {
                 cell.textContent = content ?? ''; // Use textContent for simple fields (Code, Title)
             }
        }
      return cell;
 }

    // Create 12 cells based on courseData or defaults
    newRow.appendChild(createCell(courseData?.code ?? '', true, 0)); // Code (0)
    newRow.appendChild(createCell(courseData?.title ?? '', true, 1)); // Title (1)
    newRow.appendChild(createCell(courseData?.credits ?? "0", true, 2)); // Credits (2) (uses data-cell-type)
    newRow.appendChild(createCell(courseData?.defaultRibaTheme ?? '', false, 3, 'select')); // Default RIBA Select (3)
    newRow.appendChild(createCell(courseData?.acadRibaDirect ?? '', false, 4, 'select')); // Acad RIBA Select (4)
    newRow.appendChild(createCell(courseData?.academicNotes ?? '', true, 5));          // Acad Notes (innerHTML) (5)
    newRow.appendChild(createCell(courseData?.ethicsRibaDirect ?? '', false, 6, 'select')); // Ethics RIBA Select (6)
    newRow.appendChild(createCell(courseData?.ethicsNotes ?? '', true, 7));             // Ethics Notes (innerHTML) (7)
    newRow.appendChild(createCell(courseData?.techRibaDirect ?? '', false, 8, 'select'));   // Tech RIBA Select (8)
    newRow.appendChild(createCell(courseData?.techNotes ?? '', true, 9));               // Tech Notes (innerHTML) (9)
    newRow.appendChild(createCell(courseData?.remarks ?? '', true, 10));                // Remarks (innerHTML) (10)
    newRow.appendChild(createCell(null, false, 11, 'delete'));                   // Actions (Delete Button) (11)


    if (totalRow) {
        tbody.insertBefore(newRow, totalRow);
    } else {
        tbody.appendChild(newRow);
    }

     // Populate dropdowns *after* the row is added to the DOM
     newRow.querySelectorAll('select.riba-select').forEach(select => {
         // Pass the value read from the 'value' attribute set by createCell
         populateRibaSelect(select, select.getAttribute('value') ?? '');
         select.removeAttribute('value'); // Remove the attribute after use
     });

    // Recalculate and update UI for this specific table (these are local updates, not saves)
    calculateSemesterCredits(tableId);
    calculateUnusedRiba(tableId); // Calculate unused RIBA after adding course
    updateRibaSummaryTable(); // Update the summary table

     console.log(`Course row added successfully to ${tableId}.`); // Debug log
     return newRow; // Return the new row element
}


    // This is the function called by the "Add Course" button click (onclick attribute)
    // It adds the row and triggers an autosave.
    function addCourse(tableId) {
         console.log(`Add Course button clicked for ${tableId}.`); // Debug log
         const newRow = addCourseRowToTable(tableId); // Add the row DOM element

         if (newRow) {
             // Optionally focus the first editable cell of the new row
             const firstEditableCell = newRow.querySelector('td[contenteditable="true"]');
             if (firstEditableCell) {
                 firstEditableCell.focus();
             }
              scheduleAutosave(); // Schedule autosave after adding the row
         } else {
             console.error("Failed to add course row.");
             // Handle failure (e.g., show error notification)
         }
    }


// --- Autosave Logic ---

// Schedules the autosave timer if signed in and API is ready and file ID is known.
// Clears any previous timer.
function scheduleAutosave() {
     // console.log("scheduleAutosave called."); // Debug log
     // Only schedule autosave if signed in AND API is ready AND a file ID is known
     // (Cannot save if file ID is not established yet, findOrCreate happens during first save/load)
     if (!accessToken || !isApiLoaded || !plannerFileId) {
         console.log("Not signed in, API not ready, or file ID unknown. Skipping autosave schedule."); // Debug log
         // No need to set status here, updateSignInStatus handles the not-signed-in/not-ready states
         cancelScheduledAutosave(); // Ensure no old timer is running
         return;
     }

     // Clear any existing timer
     if (saveTimerId) {
         clearTimeout(saveTimerId);
         // console.log("Cleared existing autosave timer."); // Debug log
     }

     // Set a new timer
     saveTimerId = setTimeout(() => {
         console.log("Autosave timer finished. Attempting save..."); // Debug log
         saveDataToDrive(); // Call the save function
         saveTimerId = null; // Reset timer ID after saving attempt starts
     }, AUTOSAVE_DELAY_MS);
     // console.log(`Autosave scheduled in ${AUTOSAVE_DELAY_MS}ms. Timer ID: ${saveTimerId}`); // Debug log

     // Provide quick feedback that autosave is pending, only if not already saving/saved
      if (driveStatusElement.textContent !== "Saving...") {
          setDriveStatus("Unsaved changes...", 'unsaved');
      }
}

// Clears the scheduled autosave timer.
function cancelScheduledAutosave() {
    // console.log("cancelScheduledAutosave called."); // Debug log
    if (saveTimerId) {
        clearTimeout(saveTimerId);
        saveTimerId = null;
        // console.log("Autosave timer cancelled."); // Debug log
         // If the status was showing "Unsaved changes...", revert it to the standard status
         if (driveStatusElement.classList.contains('unsaved')) {
             updateSignInStatus(); // This will set the correct status based on current state (signed in/ready)
         }
    }
}


// --- Event Handlers ---

 // Event Handler for Input on contenteditable cells and summaries, and textarea
 // Schedules autosave.
 function handleInputEvent(event) {
      const target = event.target;
      // Check if input is in an editable TD, a semester summary, or the general notes textarea.
      // Use closest for TDs within tables to be more specific.
      if (
          (target.tagName === 'TD' && target.isContentEditable && target.closest('table')) || // Editable TD within a table
          (target.classList.contains('semester-summary') && target.isContentEditable) || // Editable summary paragraph
          (target.id === 'general-notes-area') // General notes textarea
      ) {
           // console.log(`Input event detected on ${target.tagName} (ID: ${target.id || target.classList[0]}). Scheduling autosave.`); // Debug log
           scheduleAutosave();
      }
 }


 // Event Handler for Blur on Credit Cells
 // Sanitizes the input and recalculates credits locally.
 function handleCreditBlur(event) {
     const cell = event.target;
      // Ensure this is specifically a credit cell blur
      if (cell.tagName !== 'TD' || !cell.isContentEditable || cell.getAttribute('data-cell-type') !== 'credits' || !cell.closest('table')) {
          return;
      }
     console.log(`Credit cell blur event detected for ${cell.closest('table').id}. Sanitizing and calculating.`); // Debug log

     // Sanitize the input to only allow digits
     const originalValue = cell.textContent;
     let sanitizedValue = originalValue.replace(/[^0-9]/g, '');

      // If sanitation changed the value, update the cell content
      if (originalValue !== sanitizedValue) {
          cell.textContent = sanitizedValue;
           console.log(`Credit value sanitized from "${originalValue}" to "${sanitizedValue}".`);
          // Note: Setting textContent here doesn't trigger another 'input' event.
          // If the user only blurred after pasting invalid characters (no typing),
          // the 'input' handler wouldn't have fired.
          // scheduleAutosave should be called by the handleInputEvent when the user types/pastes.
          // We don't need to explicitly reschedule *just* because of sanitation on blur.
          // The autosave timer should already be running from the input event.
      }

     const table = cell.closest('table');
     if (table && table.id) {
          // Calculate credits immediately on blur for responsive UI feedback
         calculateSemesterCredits(table.id);
     }
      console.log("Credit cell blur handler finished.");
 }


 // Event Handler for Delete Row (Delegated)
 function handleDeleteRowClick(event) {
     // Check if the clicked element or its parent is the delete button
     const button = event.target.closest('.delete-row-button');
     if (!button) return; // Not a delete button click

     const row = button.closest('tr');
     if (!row) {
          console.error("Delete button found, but could not find parent row.");
          return; // Should not happen if button is found
     }

     const table = row.closest('table');
     if (!table) {
          console.error("Delete button's row is not within a table.");
          return; // Should not happen if row is in a table
     }

     console.log(`Delete button clicked in table ${table.id}.`); // Debug log

     // --- ADD CONFIRMATION DIALOG ---
     const cells = row.getElementsByTagName('td');
     let courseTitle = "this course";
     // Check cell index 1 for the title (Code is index 0, Title is index 1)
     if (cells.length > 1 && cells[1].textContent.trim()) {
          courseTitle = `"${cells[1].textContent.trim()}"`;
     }

     if (!confirm(`Are you sure you want to delete ${courseTitle}? This action cannot be undone.`)) {
         console.log("Delete cancelled by user."); // Debug log
         return; // If user clicks Cancel, stop here
     }
     // --- END CONFIRMATION DIALOG ---

     const tableId = table.id; // Get tableId before removing the row
     row.remove(); // Remove the row from the DOM
     console.log(`Row deleted successfully from ${tableId}`); // Debug log

     // Perform necessary UI updates locally
     calculateSemesterCredits(tableId); // Recalculate credits for the semester table
     calculateUnusedRiba(tableId); // Recalculate unused RIBA for the semester table
     updateRibaSummaryTable(); // Update the summary table

     scheduleAutosave(); // Schedule autosave after deletion
     // Optional: show a notification for deletion? "Course deleted"?
 }

 // --- Event Handler for RIBA Select Change (Delegated) ---
 function handleRibaSelectChange(event) {
     const target = event.target;
     if (target.tagName === 'SELECT' && target.classList.contains('riba-select')) {
         const table = target.closest('table');
         if (table && table.id) {
             console.log(`RIBA select changed in ${table.id}. Recalculating unused and summary, scheduling autosave.`); // Debug log
             // Perform necessary UI updates locally
             calculateUnusedRiba(table.id); // Recalculate unused RIBA for the affected semester
             updateRibaSummaryTable(); // Update the summary table

             scheduleAutosave(); // Schedule autosave after RIBA change
         }
     }
 }

// --- Master Event Listener Setup (Delegation where possible) ---
function setupGlobalEventListeners() {
     console.log("setupGlobalEventListeners called. Attaching listeners..."); // Debug log

     if(!plannerDiv) {
         console.error("Planner div (.curriculum-planner) not found! Global event listeners not attached.");
         return;
     }

     // Event delegation for 'input' on editable TDs, semester summaries, and the general notes textarea.
     // This covers typing/pasting in text fields, summaries, and the textarea.
     // This is the primary trigger for scheduling autosave.
     plannerDiv.addEventListener('input', handleInputEvent);

     // Event delegation for 'blur' on credit cells.
     // This is specifically for sanitizing credit inputs when editing finishes.
     // Use capture phase (true) to ensure it runs before bubbling input events might be fully processed elsewhere.
     plannerDiv.addEventListener('blur', handleCreditBlur, true);


     // Event delegation for 'change' on RIBA dropdowns.
     plannerDiv.addEventListener('change', handleRibaSelectChange);

     // Event delegation for 'click' on delete buttons.
     plannerDiv.addEventListener('click', handleDeleteRowClick);

     // Note: Add Course buttons have 'onclick' attributes which call the global `addCourse` function.
     // The `addCourse` function is designed to schedule autosave after adding the row.

     console.log("setupGlobalEventListeners finished. Listeners attached to plannerDiv.");
}


// --- Setup Button Listeners (Google Drive buttons) ---
// Moved this into a separate function from setupGlobalEventListeners
// because these buttons depend on GAPI client being loaded.
function setupButtonListeners() {
    console.log("setupButtonListeners called. Attaching Google Drive button listeners..."); // Debug log
    if (signInButton && signOutButton && saveToDriveButton && loadFromDriveButton) {
        // Note: Adding listeners here means they are added *after* GAPI loads.
        // If this function is called multiple times (it shouldn't be with DOMContentLoaded + onApiLoadComplete pattern),
        // you might get duplicate listeners. A more robust approach might be to
        // create these buttons in JS after GAPI loads. For now, assuming it runs once.
        signInButton.addEventListener('click', handleAuthClick);
        signOutButton.addEventListener('click', handleSignoutClick);
        saveToDriveButton.addEventListener('click', saveDataToDrive); // Manual save button calls save directly
        loadFromDriveButton.addEventListener('click', loadDataFromDrive);
        console.log("Google Drive button listeners attached."); // Debug log
    } else {
         console.error("One or more Google Drive buttons not found! Button listeners not attached."); // Debug log
    }
}


// --- Initial Load (Try localStorage first, fallback to default HTML) ---
// forceDefault = true can be used to explicitly load the default HTML structure, bypassing localStorage/Drive.
function initialLoad(forceDefault = false) {
    console.log(`Starting initialLoad (forceDefault: ${forceDefault}).`); // Debug log
    let dataLoaded = false;

    if (!forceDefault) {
        const savedDataString = localStorage.getItem(localStorageKey);

        if (savedDataString) {
             try {
                const savedData = JSON.parse(savedDataString);
                // Basic check for valid data structure (object with expected top-level keys)
                if (savedData && typeof savedData === 'object' && savedData.semesters && savedData.summaries !== undefined) {
                    console.log("Found data in localStorage. Attempting to apply."); // Debug log
                    // Call applyPlannerData which handles clearing existing rows and adding loaded ones
                    applyPlannerData(savedData);
                    dataLoaded = true;
                    console.log("Data loaded successfully from localStorage."); // Debug log
                     showNotification("Loaded data from your browser.", false, true); // Info notification
                } else {
                     console.warn("localStorage key found but data was empty, invalid JSON, or missing expected structure.", savedData); // Debug log
                      // Data is invalid, maybe clear it and proceed to default
                     localStorage.removeItem(localStorageKey);
                      showNotification("Error loading data from browser storage. It might be corrupted. Loading default plan.", true);
                }
            } catch (error) {
                console.error("Error parsing data from localStorage:", error); // Debug log
                 localStorage.removeItem(localStorageKey); // Clear potentially corrupted data
                 showNotification("Error loading data from browser storage. It might be corrupted. Loading default plan.", true);
                // Continue below to load default HTML structure
            }
        } else {
             console.log("No data found in localStorage."); // Debug log
        }
    } else {
         console.log("Explicitly forcing load of default HTML structure, ignoring localStorage.");
         // If forcing default, we need to explicitly clear any rows added by a failed previous load attempt
         semesterIds.forEach(semId => {
             const table = document.getElementById(`${semId}-table`);
             if(table) {
                  const tbody = table.getElementsByTagName('tbody')[0];
                   if(tbody) {
                        // Select ALL rows in tbody except the total row
                       const existingRows = tbody.querySelectorAll('tr:not(.total-credits-row)');
                       existingRows.forEach(row => row.remove());
                       console.log(`Cleared all non-total rows from ${semId}-table for forceDefault load.`);
                   }
             }
         });
          const generalNotesArea = document.getElementById('general-notes-area');
          if(generalNotesArea) generalNotesArea.value = ""; // Clear notes on forced default
          // Summary paragraphs automatically retain their default HTML content.
    }


    if (!dataLoaded) {
        // If no data was successfully loaded from localStorage (or forceDefault was true),
        // initialize the UI based on the original HTML structure that remains in the DOM.
        console.log("Initializing UI with default HTML structure."); // Debug log
         // The HTML structure (tables, rows, selects) is already in the DOM.
         // We just need to populate the selects and run initial calculations.
         initializeAllRibaDropdowns(); // Populate dropdowns for default HTML rows
         calculateAllSemestersCredits(); // Calculate credits for default data
         calculateAllSemestersUnusedRiba(); // Calculate unused RIBA for default data
         updateRibaSummaryTable(); // Build summary table for default data
          // showNotification("Using default planner template.", false, true); // Optional: Indicate default load
    }

     // Initial status message indicates API is loading (until onApiLoadComplete updates it)
     setDriveStatus("Loading Google API...");
     console.log("InitialLoad finished."); // Debug log
}


// --- Entry Point: Load APIs and Initial Data ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOMContentLoaded fired. Setting up global event listeners and starting initial load."); // Debug log

     // Setup event listeners that don't depend on GAPI first (general UI interactions like input, blur, delete, select change)
     setupGlobalEventListeners();

     // Load GIS and GAPI client libraries are initiated by script tags in head with async/defer and onload attributes.
     // The onload attributes call gisLoaded() and gapiLoaded().
     // We have defined window.gisLoaded and window.gapiLoaded *above* this listener
     // and *before* the script tags in the HTML head, which makes them globally available
     // when the async scripts finish loading and fire their onload events.

     // Start the initial data load from localStorage immediately.
     // This happens regardless of Google Sign-in status and happens *before* GAPI might load.
     initialLoad(); // This initializes the UI with default HTML or loaded data.

     // The rest of the initialization (setting up Google Drive buttons, finding/creating file)
     // happens within the callbacks (gisLoaded, gapiLoaded, initializeGapiClient, onApiLoadComplete)
     // once the Google APIs are ready and the user is signed in.

     console.log("DOMContentLoaded handler finished."); // Debug log
});

// Make necessary functions globally accessible for HTML elements (like addCourse button's onclick attribute)
window.addCourse = addCourse;

// gisLoaded and gapiLoaded are already made global by defining them with `window.` above the script tags in head


/* --- End of Refined JavaScript v11 --- */
</script>

</body>
</html>
